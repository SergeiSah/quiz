<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Вопрос викторины</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="shortcut icon" href="static/favicon.png" />
</head>

<body style="background-image: url('{{ url_for('static', filename=background) }}');
             background-size: cover;
             background-position: center;
             background-repeat: no-repeat;
             background-attachment: fixed;">


  <!-- Полароидные фотографии -->
  {% for photo in photos %}
  <div class="polaroid"
       style="position:absolute;
              top: {{ photo.style.top }}%;
              {{ photo.style.side }}: {{ photo.style.offset }}%;
              transform: rotate({{ photo.style.rotate }}deg);">
    <img src="{{ url_for('static', filename=photo.src) }}" alt="Свадебное фото">
  </div>
  {% endfor %}


  <!-- Вопрос и варианты -->
  <div class="container">
    <div class="question-box">
      <div class="question-text">{{ question_data['text'] }}</div>
    </div>

    <div class="answer-grid mx-auto">
      {% for i in range(1, 5) %}
        {% set answer = question_data['answer_' + i|string] %}
        <button class="btn btn-light btn-lg answer-btn"
                onclick="handleAnswer('{{ answer }}')"
                data-answer="{{ answer }}">
          {{ answer }}
        </button>
      {% endfor %}
    </div>


    <!-- Навигация между вопросами -->
    <div class="d-flex justify-content-between align-items-center mt-5 px-4">
      <!-- Левая стрелка -->
      <button class="btn btn-secondary fs-3 mx-5" id="prevBtn"
              {% if question_number == 1 %}disabled{% endif %}>
        &lt;
      </button>

      <!-- Правая стрелка -->
      <button class="btn btn-secondary fs-3 mx-5" id="nextBtn" disabled>
        &gt;
      </button>
    </div>

  </div>

  <!-- Начать заново -->
  <form method="POST" action="{{ url_for('restart') }}" class="text-center mt-4">
    <button type="submit" class="btn btn-outline-secondary">Перепройти</button>
  </form>

  {% include "logout.html" %}

  <!-- Скрипт обработки ответа -->
  <script>
  const correctAnswer = "{{ correct_answer }}";
  const selectedAnswers = {{ selected_answers | tojson }};
  const alreadyAnsweredCorrectly = selectedAnswers.includes(correctAnswer);
  let answeredCorrectly = alreadyAnsweredCorrectly;
  const isLastQuestion = {{ "true" if is_last_question else "false" }};
  const buttons = document.querySelectorAll(".answer-btn");

  // Подкрашиваем кнопки при загрузке
  buttons.forEach(btn => {
    const answer = btn.dataset.answer;
    if (answer === correctAnswer && alreadyAnsweredCorrectly) {
      btn.classList.add("btn-success");
      btn.disabled = true;
    } else if (selectedAnswers.includes(answer)) {
      btn.classList.add("btn-danger");
      btn.disabled = true;
    } else if (alreadyAnsweredCorrectly) {
      btn.disabled = true;
    }
  });

  // Разблокируем стрелку "вперёд" если уже есть правильный ответ
  if (alreadyAnsweredCorrectly) {
    document.getElementById("nextBtn").disabled = false;
  }

  // Обработка клика по ответу
  function handleAnswer(answer) {
    if (answeredCorrectly || selectedAnswers.includes(answer)) return;

    fetch("/answer", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        question_number: {{ question_number }},
        chosen_answer: answer
      })
    })
    .then(res => res.json())
    .then(data => {
      const btn = [...buttons].find(b => b.dataset.answer === answer);
      if (data.status === "correct") {
        btn.classList.add("btn-success");
        answeredCorrectly = true;
        buttons.forEach(b => b.disabled = true);
        document.getElementById("nextBtn").disabled = false;

        if (data.completed) {
          setTimeout(() => {
            window.location.href = "/complete";
          }, 1000);
        }
      } else {
        btn.classList.add("btn-danger");
        btn.disabled = true;
      }
    });
  }

  // Стрелки
  document.getElementById("prevBtn").addEventListener("click", () => {
    const prev = {{ question_number }} - 1;
    if (prev >= 1) {
      window.location.href = "/question/" + prev;
    }
  });

  document.getElementById("nextBtn").addEventListener("click", () => {
    if (isLastQuestion) {
      window.location.href = "/complete";
    } else {
      const next = {{ question_number }} + 1;
      window.location.href = "/question/" + next;
    }
  });

  // Свайп-навигация
  let touchStartX = null;

  document.addEventListener("touchstart", function(e) {
    touchStartX = e.changedTouches[0].screenX;
  });

  document.addEventListener("touchend", function(e) {
    if (touchStartX === null) return;

    let touchEndX = e.changedTouches[0].screenX;
    let deltaX = touchEndX - touchStartX;

    if (Math.abs(deltaX) > 50) {
      if (deltaX < 0) {
      // Свайп влево (вперёд)
      if (answeredCorrectly) {
        if (isLastQuestion) {
          window.location.href = "/complete";
        } else {
          const next = {{ question_number }} + 1;
          window.location.href = "/question/" + next;
        }
      }
    } else {
        // Свайп вправо (назад)
        const prev = {{ question_number }} - 1;
        if (prev >= 1) {
          window.location.href = "/question/" + prev;
        }
      }
    }

    touchStartX = null;
  });
  </script>

</body>
</html>