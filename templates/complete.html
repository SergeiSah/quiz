<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–∑—É–ª—å—Ç–∞—Ç</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="shortcut icon" href="static/favicon.png" />
</head>

<body class="bg-light d-flex align-items-center justify-content-center"
      style="height: 100dvh;
             background-image: url('{{ url_for('static', filename=background) }}');
             background-position: center;">

  <div class="text-center">
    {% if result_code not in codes_info %}
      <div class="complete-info">
        <h1 class="mb-4">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! üéâ</h1>
        <p>–í–∞—à –∫–æ–¥ –æ—Ç –∑–∞–º–∫–∞:</p>
        <div class="display-4 fw-bold">{{ result_code }}</div>
        <p class="mt-3 h5">–ù–µ–≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ {{ errors }} (–∏–∑ {{ total_questions }} –≤–æ–ø—Ä–æ—Å–æ–≤)</p>
      </div>

    {% else %}
      <div class="complete-info">
        <h1>{{ codes_info[result_code] }}</h1>
        <p class="mt-3 h5">–ù–µ–≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ {{ errors }} (–∏–∑ {{ total_questions }} –≤–æ–ø—Ä–æ—Å–æ–≤)</p>
      </div>

    {% endif %}

    <form method="POST" action="{{ url_for('restart') }}" class="mt-5">
      <button type="submit" class="btn btn-outline-dark again_btn">–ü—Ä–æ–π—Ç–∏ —Å–Ω–æ–≤–∞</button>
    </form>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" —Å–ª–µ–≤–∞ —Å–≤–µ—Ä—Ö—É -->
  <button id="statsBtn"
        type="button"
        class="btn btn-outline-dark position-absolute top-0 start-0 m-3 statistic_btn"
        style="z-index: 2001"
        data-bs-toggle="modal"
        data-bs-target="#statsModal"
        onclick="loadStats()">
  –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
</button>

  {% include "logout.html" %}

  <!-- Modal: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="modal fade" id="statsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex align-items-center gap-2 mb-2">
            <label for="statsLimit" class="form-label mb-0">–ü–æ–∫–∞–∑–∞—Ç—å:</label>
            <select id="statsLimit" class="form-select form-select-sm" style="width:auto">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
            </select>
            <button id="reloadStats" class="btn btn-sm btn-outline-secondary">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>–í—Ä–µ–º—è</th>
                  <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                  <th>–û—à–∏–±–æ–∫</th>
                  <th>–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤</th>
                </tr>
              </thead>
              <tbody id="statsTableBody">
                <tr><td colspan="4" class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>

        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <script>
      window.onload = function () {
          // –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –≤–æ–ª–Ω–æ–π
          var duration = 5 * 1000;
          var animationEnd = Date.now() + duration;
          var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

          function randomInRange(min, max) {
              return Math.random() * (max - min) + min;
          }

          var interval = setInterval(function () {
              var timeLeft = animationEnd - Date.now();

              if (timeLeft <= 0) {
                  return clearInterval(interval);
              }

              var particleCount = 50 * (timeLeft / duration);
              // –∑–∞–ø—É—Å–∫ —Å –¥–≤—É—Ö —Å—Ç–æ—Ä–æ–Ω
              confetti(Object.assign({}, defaults, {
                  particleCount,
                  origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
              }));
              confetti(Object.assign({}, defaults, {
                  particleCount,
                  origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
              }));
          }, 250);
      }

  const STATS_URL = "{{ url_for('stats_recent') }}";

  const statsModalEl   = document.getElementById('statsModal');
  const statsTableBody = document.getElementById('statsTableBody');
  const statsLimit     = document.getElementById('statsLimit');
  const reloadBtn      = document.getElementById('reloadStats');

  function setRowMessage(msg, isError=false, colspan=4) {
    const cls = isError ? 'text-danger' : 'text-muted';
    statsTableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center ${cls}">${msg}</td></tr>`;
  }

  function renderRows(items) {
    if (!Array.isArray(items) || items.length === 0) {
      setRowMessage('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
      return;
    }
    const rows = items.map(item => `
      <tr>
        <td><code>${item.created_at}</code></td>
        <td>${item.username}</td>
        <td>${item.errors}</td>
        <td>${item.total}</td>
      </tr>
    `).join('');
    statsTableBody.innerHTML = rows;
  }

  async function loadStats() {
    try {
      setRowMessage('–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶');
      const limit = encodeURIComponent(statsLimit?.value || '20');
      const res = await fetch(`${STATS_URL}?limit=${limit}`, { credentials: 'same-origin', cache: 'no-store' });

      if (res.redirected) { setRowMessage('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', true); return; }

      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        setRowMessage('–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON', true);
        return;
      }
      if (!res.ok) {
        setRowMessage(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (HTTP ${res.status})`, true);
        return;
      }

      const data = await res.json();
      renderRows(data.items);
    } catch (e) {
      setRowMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', true);
      console.error(e);
    }
  }

  // –¥–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è onclick
  window.loadStats = loadStats;

  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–µ–ª–µ–∫—Ç–∞ –∏ –∫–Ω–æ–ø–∫–∏
  reloadBtn?.addEventListener('click', loadStats);
  statsLimit?.addEventListener('change', loadStats);

  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ ‚Äî –≥—Ä—É–∑–∏—Ç—å –∏ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –º–æ–¥–∞–ª–∫–∏
  statsModalEl?.addEventListener('shown.bs.modal', loadStats);
  </script>

</body>
</html>